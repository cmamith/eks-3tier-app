name: DevSecOps Pipeline (Step 1 - Setup)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Environment
        run: |
          echo "‚úÖ GitHub Actions environment ready!"
          pwd
          ls -la
    
  sonar-scan:
    name: SonarQube Scan
    runs-on: self-hosted
    needs: setup

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java (required by SonarQube)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Sonar Scanner
        run: |
          mkdir -p $HOME/sonar
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner-cli-5.0.1.3006-linux.zip -d $HOME/sonar
          echo "$HOME/sonar/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH

      - name: Run SonarQube Analysis (Local)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: "http://localhost:9000"
        run: |
          echo "üîç Running SonarQube analysis on local instance..."
          sonar-scanner \
            -Dsonar.projectKey=eks-3tier-app \
            -Dsonar.projectName=eks-3tier-app \
            -Dsonar.sources=. \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN

      - name: Wait for SonarQube Quality Gate Result
        env:
          SONAR_HOST_URL: "http://localhost:9000"
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "‚è≥ Checking Quality Gate status..."
          for i in {1..20}; do
            status=$(curl -s -u $SONAR_TOKEN: "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=eks-3tier-app" | jq -r '.projectStatus.status')
            echo "Current status: $status"
            if [ "$status" == "OK" ]; then
              echo "‚úÖ Quality Gate PASSED!"
              exit 0
            elif [ "$status" == "ERROR" ]; then
              echo "‚ùå Quality Gate FAILED!"
              exit 1
            else
              echo "‚è≥ Waiting for analysis to finish..."
              sleep 15
            fi
          done
          echo "‚ö†Ô∏è Timed out waiting for Quality Gate result."
          exit 1
